<?phpclass RptQc extends ReportData2 {	public function fields() {		return array(			'entry_dt'=>array('label'=>Yii::t('qc','Entry Date'),'width'=>18,'align'=>'C'),			'job_staff'=>array('label'=>Yii::t('qc','Resp. Staff'),'width'=>30,'align'=>'L'),			'team'=>array('label'=>Yii::t('qc','Team'),'width'=>22,'align'=>'C'),			'month'=>array('label'=>Yii::t('qc','Month'),'width'=>10,'align'=>'C'),//			'input_dt'=>array('label'=>Yii::t('qc','Input Date'),'width'=>18,'align'=>'C'),			'company_name'=>array('label'=>Yii::t('qc','Customer'),'width'=>30,'align'=>'L'),			'service_type'=>array('label'=>Yii::t('qc','Service Type'),'width'=>15,'align'=>'C'),			'service_score'=>array('label'=>Yii::t('qc','Service Score'),'width'=>15,'align'=>'C'),			'cust_score'=>array('label'=>Yii::t('qc','Customer Score'),'width'=>15,'align'=>'C'),			'cust_comment'=>array('label'=>Yii::t('qc','Customer Comment'),'width'=>30,'align'=>'C'),			'qc_result'=>array('label'=>Yii::t('qc','QC Result'),'width'=>15,'align'=>'C'),			'env_grade'=>array('label'=>Yii::t('qc','Env. Grade'),'width'=>20,'align'=>'C'),			'qc_dt'=>array('label'=>Yii::t('qc','QC Date'),'width'=>18,'align'=>'C'),			'cust_sign'=>array('label'=>Yii::t('qc','Signature'),'width'=>22,'align'=>'L'),			'qc_staff'=>array('label'=>Yii::t('qc','Staff-QC'),'width'=>30,'align'=>'L'),			'remarks'=>array('label'=>Yii::t('enquiry','Remarks'),'width'=>40,'align'=>'L'),            'bool'=>array('label'=>Yii::t('enquiry','Bool'),'width'=>40,'align'=>'L'),		);	}	public function retrieveData() {//		$city = Yii::app()->user->city();		$city = $this->criteria->city;		$sql = "select a.*					from swo_qc a 		";		$where = "where a.city='".$city."'";		if (isset($this->criteria)) {			if (isset($this->criteria->start_dt))				$where .= (($where=='where') ? " " : " and ")."entry_dt>='".General::toDate($this->criteria->start_dt)."'";			if (isset($this->criteria->end_dt))				$where .= (($where=='where') ? " " : " and ")."entry_dt<='".General::toDate($this->criteria->end_dt)."'";		}		if ($where!='where') $sql .= $where;			$sql .= " order by entry_dt desc";		$rows = Yii::app()->db->createCommand($sql)->queryAll();        $sqls="select a.id from swo_qc aleft outer join swo_qc_info b on a.id=b.qc_id and b.field_id='sign_cust'left outer join swo_qc_info c on a.id=c.qc_id and c.field_id='sign_qc'left outer join swo_qc_info d on a.id=d.qc_id and d.field_id='sign_cust'where b.field_blob='' or c.field_blob='' or d.field_blob='' and a.id=''";        $nook = Yii::app()->db->createCommand($sqls)->queryAll();        $arr = array();        if(count($nook) > 0){            foreach ($nook as $nooks) {                $arr[] = $nooks['id'];            }        }		if (count($rows) > 0) {			foreach ($rows as $row) {                $bool = in_array($row['id'],$arr);				$temp = array();				$temp['entry_dt'] = General::toDate($row['entry_dt']);				$temp['job_staff'] = $row['job_staff'];				$temp['team'] = $row['team'];				$temp['month'] = $row['month'];				$temp['input_dt'] = General::toDate($row['input_dt']);				$temp['company_name'] = $row['company_name'];				$temp['service_type'] = $row['service_type'];				$temp['service_score'] = $row['service_score'];				$temp['cust_score'] = $row['cust_score'];				$temp['cust_comment'] = $row['cust_comment'];				$temp['qc_result'] = (is_numeric($row['qc_result']))						? (($row['qc_result'] < 70) ? $row['qc_result'].' **' : $row['qc_result'])						: $row['qc_result'];				$temp['env_grade'] = $row['env_grade'];				$temp['qc_dt'] = General::toDate($row['qc_dt']);				$temp['cust_sign'] = $row['cust_sign'];				$temp['qc_staff'] = $row['qc_staff'];				$temp['remarks'] = $row['remarks'];                $temp['bool'] = $bool==1?"未完成":"已完成";				$this->data[] = $temp;			}		}		return true;	}	public function getReportName() {		$city_name = isset($this->criteria) ? ' - '.General::getCityName($this->criteria->city) : '';		return parent::getReportName().$city_name;	}}?>